<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"christopher-teng.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="&amp;emsp;&amp;emsp;Flask 是 Python 世界中非常流行的 Web 框架之一，其以轻量和上手简单著称，被称作微框架(microframework)，它可以很好的结合 MVC 模式，通过丰富的插件库根据自身需求进行定制化，在短时间内就能完成一个功能丰富的中小型 Web 服务开发。 &amp;emsp;&amp;emsp;本文中我们将尝试使用 Flask 来实现简单的用户注册登录功能，涉及到构建蓝图、使用">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Flask实现简单的用户注册登录功能">
<meta property="og:url" content="https://christopher-teng.github.io/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/index.html">
<meta property="og:site_name" content="Christopher Teng&#39;s Blog">
<meta property="og:description" content="&amp;emsp;&amp;emsp;Flask 是 Python 世界中非常流行的 Web 框架之一，其以轻量和上手简单著称，被称作微框架(microframework)，它可以很好的结合 MVC 模式，通过丰富的插件库根据自身需求进行定制化，在短时间内就能完成一个功能丰富的中小型 Web 服务开发。 &amp;emsp;&amp;emsp;本文中我们将尝试使用 Flask 来实现简单的用户注册登录功能，涉及到构建蓝图、使用">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://christopher-teng.github.io/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/skeleton.jpeg">
<meta property="og:image" content="https://christopher-teng.github.io/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/static_dir.jpeg">
<meta property="article:published_time" content="2021-07-21T08:26:26.000Z">
<meta property="article:modified_time" content="2021-08-22T11:53:40.220Z">
<meta property="article:author" content="滕飞">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Flask">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://christopher-teng.github.io/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/skeleton.jpeg">

<link rel="canonical" href="https://christopher-teng.github.io/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>使用Flask实现简单的用户注册登录功能 | Christopher Teng's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Christopher Teng's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Christopher Teng's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">关注技术、持续提升</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">6</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/Christopher-Teng" class="github-corner" title="Christopher-Teng Github" aria-label="Christopher-Teng Github" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://christopher-teng.github.io/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="滕飞">
      <meta itemprop="description" content="学海无涯，争渡争渡......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Christopher Teng's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用Flask实现简单的用户注册登录功能
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-21 16:26:26" itemprop="dateCreated datePublished" datetime="2021-07-21T16:26:26+08:00">2021-07-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-22 19:53:40" itemprop="dateModified" datetime="2021-08-22T19:53:40+08:00">2021-08-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Web开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&emsp;&emsp;Flask 是 Python 世界中非常流行的 Web 框架之一，其以轻量和上手简单著称，被称作微框架(microframework)，它可以很好的结合 MVC 模式，通过丰富的插件库根据自身需求进行定制化，在短时间内就能完成一个功能丰富的中小型 Web 服务开发。</p>
<p>&emsp;&emsp;本文中我们将尝试使用 Flask 来实现简单的用户注册登录功能，涉及到构建蓝图、使用 jinja2 模板引擎渲染前端页面、使用 SQLAlchemy 操作 MySQL 数据库、使用 WTForms 验证用户提交的表单信息、使用 Cookie 保存用户登录状态、设置路由守卫对页面进行访问控制，最后使用自定义函数装饰器和 Python 标准库中的 contextmanager 上下文管理器，优化数据库操作，增加设置默认查询条件功能和操作失败自动回滚功能。通过这样一个简单的项目，能够对使用 Flask 进行 Web 开发的流程有一个初步的认识，并且熟悉一些开发中常用的 Flask 第三方插件，提升代码质量、加快开发速度，避免重复造轮子。</p>
<h2 id="搭建项目结构"><a href="#搭建项目结构" class="headerlink" title="搭建项目结构"></a>搭建项目结构</h2><p>&emsp;&emsp;如下图所示：</p>
<img src="/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/skeleton.jpeg" class="" title="project skeleton">
<p>&emsp;&emsp;根目录下的 app.py 作为入口文件启动项目，app 是整个项目的开发目录，app/config 是配置文件目录、app/forms 是表单校验文件目录、app/lib 是自定义工具类文件目录、app/manager 是路由蓝图文件目录、app/models 是数据库文件目录、app/static 是静态文件目录、app/templates 是模板文件目录。</p>
<p>&emsp;&emsp;项目根目录下的 Pipfile 和 Pipefile.lock 是使用 pipenv 构建虚拟开发环境产生的配置文件。</p>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>&emsp;&emsp;要使用 Flask 启动一个 Web 服务非常简单：创建一个 Flask 实例，传入自定义配置或者直接使用默认配置，定义一个路由绑定视图函数，调用实例的 run 方法。</p>
<p>&emsp;&emsp;首先在 app/<strong>init</strong>.py 中创建实例并进行配置：</p>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>():</span></span><br><span class="line">    app=Flask(__name__)</span><br><span class="line">    app.config.from_pyfile(<span class="string">&quot;config/setting.py&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;然后在项目入口文件 app.py 中导入 Flask 实例并启动服务：</p>
<figure class="highlight python"><figcaption><span>app.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> create_app</span><br><span class="line"></span><br><span class="line">app=create_app()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;h1&gt;Hello World!&lt;/h1&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main&quot;</span>:</span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里调用 run 方法时传入参数<code>host=&quot;0.0.0.0&quot;</code>是为了可以在开发时通过局域网内的设备进行访问。</p>
<p>&emsp;&emsp;对于配置文件来说，到目前只需要配置开启 debug 模式，方便开发中发生错误时查看详细异常信息。</p>
<figure class="highlight python"><figcaption><span>app/config/setting.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBUG=<span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;最后，运行入口文件启动服务：</p>
<blockquote>
<p>$ python ./app.py</p>
</blockquote>
<p>&emsp;&emsp;浏览器访问 localhost:5000 就可以看到项目首页。</p>
<span id="more"></span>
<h2 id="路由和蓝图"><a href="#路由和蓝图" class="headerlink" title="路由和蓝图"></a>路由和蓝图</h2><p>&emsp;&emsp;蓝图(blueprint)是一个模块化处理的类，它将单个应用的视图、模板和静态文件进行结合，可以看作是一个存储和操作路由映射方法的容器，主要用来实现客户端请求和 URL 相互关联的功能。</p>
<p>&emsp;&emsp;下面我们将之前注册的首页路由以蓝图的方式来实现。</p>
<p>&emsp;&emsp;在项目根目录下的 manager 目录用于统一存放蓝图文件，首先创建一个名为 web 的蓝图：</p>
<figure class="highlight python"><figcaption><span>app/manager/blueprint.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">web=Blueprint(<span class="string">&quot;web&quot;</span>,__name__,url_prefix=<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;然后使用新创建的蓝图来注册首页路由：</p>
<figure class="highlight python"><figcaption><span>app/manager/web.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .blueprint <span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;&lt;h1&gt;Hello World!&lt;/h1&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在 app/manager/<strong>init</strong>.py 中引入该目录下的 web.py，这样之后导入 app/manager 时会自动应用 web.py 中注册的路由：</p>
<figure class="highlight python"><figcaption><span>app/manager/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> web</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;最后，在应用中注册新创建的蓝图：</p>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_blueprint</span>(<span class="params">app</span>):</span></span><br><span class="line">  <span class="keyword">from</span> .manager.blueprint <span class="keyword">import</span> web</span><br><span class="line">  app.register_blueprint(web)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>():</span></span><br><span class="line">  app=Flask(__name__)</span><br><span class="line">  app.config.from_pyfile(<span class="string">&quot;config/setting.py&quot;</span>)</span><br><span class="line">  register_blueprint(app)</span><br><span class="line">  <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>&emsp;&emsp;在 Python 世界中，连接关系型数据库常用 SQLAlchemy，其秉持 Code First 的思想，以 ORM(对象关系映射)的方式操作数据库，大大降低了开发难度。在 Flask 的插件库中同样有对应的插件 Flask-SQLAlchemy，该插件对原生的 SQLAlchemy 进行了封装，方便和 Flask 结合使用。</p>
<h3 id="初步实现"><a href="#初步实现" class="headerlink" title="初步实现"></a>初步实现</h3><p>&emsp;&emsp;首先对数据库进行配置：</p>
<figure class="highlight python"><figcaption><span>app/config/setting.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEBUG=<span class="literal">True</span></span><br><span class="line">SECRET_KEY=<span class="string">&quot;!@#$%^&amp;*&quot;</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI=<span class="string">&quot;mysql+pymysql://root:123456@localhost:3306/flask&quot;</span></span><br><span class="line">SQLALCHEMY_ECHO=<span class="literal">True</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATION=<span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;配置项都比较简单易懂，具体说明可以自行网上查看。</p>
<p>&emsp;&emsp;接下来进行数据表的定义，在 app/models 目录中统一存放数据库操作相关文件，首先创建一个基类，用于定义后面将要实现的用户表中的用户注册时间字段以及激活/冻结状态字段。</p>
<figure class="highlight python"><figcaption><span>app/models/base.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column,Integer,SmallInteger</span><br><span class="line"></span><br><span class="line">db=SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">  __abstract__=<span class="literal">True</span></span><br><span class="line">  status=Column(SmallInteger,default=<span class="number">1</span>)</span><br><span class="line">  create_time=Column(<span class="string">&quot;create_time&quot;</span>,Integer,nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.create_time=<span class="built_in">int</span>(datetime.now().timestamp())</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里在 Base 类中设置<code>__abstract__=True</code>是因为这只是定义一个基类，不需要在数据库中对应生成一个表，如果不设置<code>__abstract__=True</code>，则 SQLAlchemy 会因为 Base 类中没有指定主键而报错。</p>
<p>&emsp;&emsp;接下来实现用户表：</p>
<figure class="highlight python"><figcaption><span>app/models/user.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column,Integer,String</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">  <span class="built_in">id</span>=Column(Integer,primary_key=<span class="literal">True</span>)</span><br><span class="line">  nickname=Column(String(<span class="number">20</span>),nullable=<span class="literal">False</span>)</span><br><span class="line">  email=Column(String(<span class="number">50</span>),nullable=<span class="literal">False</span>,unique=<span class="literal">True</span>)</span><br><span class="line">  phone_number=Column(<span class="string">&quot;phone_number&quot;</span>,String(<span class="number">11</span>),nullable=<span class="literal">False</span>,unique=<span class="literal">True</span>)</span><br><span class="line">  password=Column(String(<span class="number">32</span>),nullable=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;最后，在应用中初始化 ORM 模型并且创建数据表：</p>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_blueprint</span>(<span class="params">app</span>):</span></span><br><span class="line">  <span class="keyword">from</span> .manager.blueprint <span class="keyword">import</span> web</span><br><span class="line">  app.register_blueprint(web)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_db</span>(<span class="params">app</span>):</span></span><br><span class="line">  <span class="keyword">from</span> .models.base <span class="keyword">import</span> db</span><br><span class="line">  db.init_app(app)</span><br><span class="line">  db.create_all(app=app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>():</span></span><br><span class="line">  app=Flask(__name__)</span><br><span class="line">  app.config.from_pyfile(<span class="string">&quot;config/setting.py&quot;</span>)</span><br><span class="line">  register_blueprint(app)</span><br><span class="line">  create_db(app)</span><br><span class="line">  <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<h3 id="对用户密码进行加密"><a href="#对用户密码进行加密" class="headerlink" title="对用户密码进行加密"></a>对用户密码进行加密</h3><p>&emsp;&emsp;让我们在回过头看看用户表的定义，其中有几个问题，首先，用户密码任何时候都不能以明文存储，这一点可以利用 Flask 使用的 WSGI 工具包——werkzeug 来解决：</p>
<figure class="highlight python"><figcaption><span>app/models/user.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column,Integer,String</span><br><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> check_password_hash,generate_password_hash</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">  <span class="built_in">id</span>=Column(Integer,primary_key=<span class="literal">True</span>)</span><br><span class="line">  nickname=Column(String(<span class="number">20</span>),nullable=<span class="literal">False</span>)</span><br><span class="line">  email=Column(String(<span class="number">50</span>),nullable=<span class="literal">False</span>,unique=<span class="literal">True</span>)</span><br><span class="line">  phone_number=Column(<span class="string">&quot;phone_number&quot;</span>,String(<span class="number">11</span>),nullable=<span class="literal">False</span>,unique=<span class="literal">True</span>)</span><br><span class="line">  _password=Column(<span class="string">&quot;password&quot;</span>,String(<span class="number">128</span>),nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @property</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">password</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self._password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">  @password.setter</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">password</span>(<span class="params">self,raw</span>):</span></span><br><span class="line">    self._password=generate_password_hash(raw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check_password</span>(<span class="params">self,raw</span>):</span></span><br><span class="line">    <span class="keyword">return</span> check_password_hash(self.password,raw)</span><br></pre></td></tr></table></figure>
<h3 id="设置默认查表条件"><a href="#设置默认查表条件" class="headerlink" title="设置默认查表条件"></a>设置默认查表条件</h3><p>&emsp;&emsp;在实际应用中，用户注册或删除一般采用软删除的方式，及设置标志位，这里我们在 Base 类中使用<code>status</code>来表示，默认值 1 表示用户为激活状态，设为 0 则表示用户被冻结。因此，当我们查询用户表时，始终都应该指定<code>status=1</code>为查询条件，如果总是在执行查询命令时手动指定，无疑使代码非常冗余，因此我们需要实现一个指定默认查询条件的功能。</p>
<p>&emsp;&emsp;在 app/lib 目录下创建一些自定义工具类：</p>
<figure class="highlight python"><figcaption><span>app/lib/helper.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_query_conditions</span>(<span class="params">**conditions</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">    @wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">      <span class="keyword">for</span> k,v <span class="keyword">in</span> conditions.items():</span><br><span class="line">        <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> kwargs.keys():</span><br><span class="line">          kwargs[k]=v</span><br><span class="line">      <span class="keyword">return</span> func(*args,**kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line">  <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;<code>set_query_conditions</code>是一个自定义函数装饰器，接下来对 app/models/base 中 Base 类所继承的 db.Model 进行改在，利用我们的自定义函数装饰器为数据库查询方法<code>filter_by</code>指定默认条件：</p>
<figure class="highlight python"><figcaption><span>app/models/base.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> BaseQuery,SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column,Integer,SmallInteger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..lib.helper <span class="keyword">import</span> set_query_conditions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomQuery</span>(<span class="params">BaseQuery</span>):</span></span><br><span class="line"><span class="meta">  @set_query_conditions(<span class="params">status=<span class="number">1</span></span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">filter_by</span>(<span class="params">self,**kwargs</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>().filter_by(**kwargs)</span><br><span class="line"></span><br><span class="line">db=SQLAlchemy(query_class=CustomQuery)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">  __abstract__=<span class="literal">True</span></span><br><span class="line">  status=Column(SmallInteger,default=<span class="number">1</span>)</span><br><span class="line">  create_time=Column(<span class="string">&quot;create_time&quot;</span>,Integer,nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.create_time=<span class="built_in">int</span>(datetime.now().timestamp())</span><br></pre></td></tr></table></figure>
<h3 id="操作失败自动回滚"><a href="#操作失败自动回滚" class="headerlink" title="操作失败自动回滚"></a>操作失败自动回滚</h3><p>&emsp;&emsp;最后，我们还可以对数据库操作进一步优化，添加上自动回滚功能，这里可以通过 Python 标准库 contextlib 中的 contextmanager 来实现，其原理是使用了上下文管理器，在进入和离开上下文环境时，执行指定的操作，具体细节可以上网查看：</p>
<figure class="highlight python"><figcaption><span>app/models/base.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> BaseQuery,SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column,Integer,SmallInteger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..lib.helper <span class="keyword">import</span> set_query_conditions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomQuery</span>(<span class="params">BaseQuery</span>):</span></span><br><span class="line"><span class="meta">  @set_query_conditions(<span class="params">status=<span class="number">1</span></span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">filter_by</span>(<span class="params">self,**kwargs</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>().filter_by(**kwargs)</span><br><span class="line"></span><br><span class="line">db=SQLAlchemy(query_class=CustomQuery)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">  __abstract__=<span class="literal">True</span></span><br><span class="line">  status=Column(SmallInteger,default=<span class="number">1</span>)</span><br><span class="line">  create_time=Column(<span class="string">&quot;create_time&quot;</span>,Integer,nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.create_time=<span class="built_in">int</span>(datetime.now().timestamp())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line"><span class="meta">  @contextmanager</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">auto_commit</span>(<span class="params">cls</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="keyword">yield</span></span><br><span class="line">      db.session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">      db.session.rollback()</span><br><span class="line">      <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>
<h2 id="校验表单数据"><a href="#校验表单数据" class="headerlink" title="校验表单数据"></a>校验表单数据</h2><p>&emsp;&emsp;Flask 内部并没有提供全面的表单验证功能，所以需要借助一些第三方插件来实现，这里采用了 WTForms。WTForms 是一个支持多种 Web 框架的 Form 插件，主要用于对用户请求数据进行校验，而 Flask 插件库中也有对应版本——Flask-WTForms。</p>
<p>&emsp;&emsp;在 app/forms 目录下新建 auth.py 用来统一编写表单校验类：</p>
<figure class="highlight python"><figcaption><span>app/forms/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> PasswordField,StringField,ValidationError</span><br><span class="line"><span class="keyword">from</span> wtforms.fields.html5 <span class="keyword">import</span> EmailField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired,Length,Email,Regexp</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..models.user <span class="keyword">import</span> User</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;注意，这里用到的邮箱验证器可能需要单独安装 email-validator 包，可以自行视情况进行安装。</p>
<p>&emsp;&emsp;接上文，在 app/forms/auth.py 中定义表单验证类，其中除了使用 WTForms 提供的标准验证器外，还使用了自定义验证器，方式是以 <code>validate_[字段名称](self,field)</code>为名定义实例方法，WTForms 会将其自动应用到对应的字段上，而验证失败则需要抛出 WTForms 的 ValidationError 类的实例：</p>
<figure class="highlight python"><figcaption><span>app/forms/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    nickname = StringField(validators=[DataRequired(),</span><br><span class="line">                                       Length(<span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">20</span>),</span><br><span class="line">                                       Regexp(<span class="string">r&quot;^\w&#123;4,20&#125;$&quot;</span>, flags=<span class="number">0</span>, message=<span class="string">u&quot;用户昵称最少4位最多20位字符，并且不能使用特殊字符！&quot;</span>)])</span><br><span class="line">    email = EmailField(validators=[DataRequired(),</span><br><span class="line">                                   Length(<span class="built_in">min</span>=<span class="number">6</span>, <span class="built_in">max</span>=<span class="number">50</span>)])</span><br><span class="line">    phone_number = StringField(validators=[DataRequired(),</span><br><span class="line">                                           Length(<span class="built_in">min</span>=<span class="number">11</span>, <span class="built_in">max</span>=<span class="number">11</span>),</span><br><span class="line">                                           Regexp(<span class="string">r&quot;^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\d&#123;8&#125;$&quot;</span>, flags=<span class="number">0</span>, message=<span class="string">u&quot;无效的手机号码&quot;</span>)])</span><br><span class="line">    password = PasswordField(validators=[DataRequired(),</span><br><span class="line">                                         Length(<span class="built_in">min</span>=<span class="number">6</span>, <span class="built_in">max</span>=<span class="number">32</span>),</span><br><span class="line">                                         Regexp(<span class="string">r&quot;^\w&#123;6,32&#125;$&quot;</span>, flags=<span class="number">0</span>, message=<span class="string">u&quot;密码最少6位最多32位字符，并且不能使用特殊字符&quot;</span>)])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_email</span>(<span class="params">self, field</span>):</span></span><br><span class="line">        <span class="keyword">if</span> User.query.filter_by(email=field.data).first():</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">u&quot;该邮箱已被注册！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_phone_number</span>(<span class="params">self, field</span>):</span></span><br><span class="line">        <span class="keyword">if</span> User.query.filter_by(phone_number=field.data):</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">u&quot;该手机号码已被注册！&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="用户注册接口与页面"><a href="#用户注册接口与页面" class="headerlink" title="用户注册接口与页面"></a>用户注册接口与页面</h2><h3 id="路由和视图函数"><a href="#路由和视图函数" class="headerlink" title="路由和视图函数"></a>路由和视图函数</h3><p>&emsp;&emsp;首先新建一个蓝图管理与用户操作相关的路由：</p>
<figure class="highlight python"><figcaption><span>app/manager/blueprint.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">web=Blueprint(<span class="string">&quot;web&quot;</span>,__name__,url_prefix=<span class="string">&quot;/&quot;</span>)</span><br><span class="line">auth=Blueprint(<span class="string">&quot;auth&quot;</span>,__name__,url_prefix=<span class="string">&quot;/user&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;新建一个文件统一管理用户路由相关的视图函数：</p>
<figure class="highlight python"><figcaption><span>app/manager/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> flash,redirect,render_template,url_for,request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..forms.auth <span class="keyword">import</span> UserForm</span><br><span class="line"><span class="keyword">from</span> ..models.base <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> ..models.user <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> .blueprint <span class="keyword">import</span> auth</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&quot;/register&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>():</span></span><br><span class="line">  form=UserForm()</span><br><span class="line">  <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;&lt;h1&gt;Register Page&lt;/h1&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里通过 flask-wtforms 提供的 validate_on_submit 方法，在得到客户端通过 POST 请求提交表单内容并且通过表单数据校验后，做进一步处理，而通过 GET 请求访问路由时则返回 html。这里暂时先返回一个页面标题，后面会使用 jinja2 模板引擎渲染 html 页面进行返回。</p>
<p>&emsp;&emsp;接下来完成用户注册逻辑：</p>
<figure class="highlight python"><figcaption><span>app/manager/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文if语句块</span></span><br><span class="line"><span class="comment"># if form.validate_on_submit():</span></span><br><span class="line">  nickname=form.data.get(<span class="string">&quot;nickname&quot;</span>)</span><br><span class="line">  email=form.data.get(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">  phone_number=form.data.get(<span class="string">&quot;phone_number&quot;</span>)</span><br><span class="line">  password=form.data.get(<span class="string">&quot;password&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;首先通过前面定义的 UserForm 类的实例来获得用户提交的表单数据，这里所获得的数据都是通过 wtforms 校验后的正确数据，而校验失败的信息会被放入 form.errors 中，后面会在通过模板引擎渲染 html 页面时通过条件判断，在页面中显示校验失败的错误信息。</p>
<p>&emsp;&emsp;下面新建一条用户记录并写入数据库：</p>
<figure class="highlight python"><figcaption><span>app/manager/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line">  user=User()</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里实例化一个 user 后需要添加用户属性，因此在 Base 类中增加一个添加用户属性的方法：</p>
<figure class="highlight python"><figcaption><span>app/models/base.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Base类中添加add_attrs方法</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add_attrs</span>(<span class="params">self,**attrs</span>):</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> attrs.items():</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">hasattr</span>(self,k) <span class="keyword">and</span> k!=<span class="string">&quot;id&quot;</span>:  <span class="comment"># 不能指定主键</span></span><br><span class="line">        <span class="built_in">setattr</span>(self,k,v)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;回到用户注册视图函数中继续编写：</p>
<figure class="highlight python"><figcaption><span>app/manager/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line">  user.add_attrs(nickname=nickname,</span><br><span class="line">                 email=email,</span><br><span class="line">                 phone_number=phone_number,</span><br><span class="line">                 password=password)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> User.auto_commit():</span><br><span class="line">      db.session.add(user)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;auth.login&quot;</span>))</span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> _:</span><br><span class="line">    flash(<span class="string">u&quot;注册失败！&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;当成功注册以后，跳转到登录试图，否侧提示注册失败，这里所使用的 flash 是 Flask 提供的消息闪现方法，可以在渲染 html 页面时取得该方法传递的信息在页面中进行展示，后面在使用模板引擎编写 html 页面时会用到。</p>
<p>&emsp;&emsp;注意这里在想数据库写入数据时，通过 with…as 语句调用了前面自定义的方法：auto_commit(由于该方法并没有返回值，所以省略了 as 关键字)，该方法通过 python 的上下文管理器来实现数据库操作失败自动回滚，并抛出错误。</p>
<p>&emsp;&emsp;下面在应用中注册蓝图，引入路由：</p>
<figure class="highlight python"><figcaption><span>app/manager/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> auth,web</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># register_blueprint函数定义内</span></span><br><span class="line"><span class="comment"># def register_blueprint(app):</span></span><br><span class="line">  <span class="keyword">from</span> .manager.blueprint <span class="keyword">import</span> auth,web</span><br><span class="line">  app.register_blueprint(auth)</span><br><span class="line">  app.register_blueprint(web)</span><br></pre></td></tr></table></figure>
<h3 id="模板引擎与注册页面"><a href="#模板引擎与注册页面" class="headerlink" title="模板引擎与注册页面"></a>模板引擎与注册页面</h3><p>&emsp;&emsp;下面使用 jinja2 模板引擎编写 html 页面。所有模板文件统一放置与 app/templates 目录下进行管理，这也是 Flask 默认的模板文件查找目录。jinja2 支持变量、条件、循环、继承等特性，具体使用方法可以上网查看。</p>
<p>&emsp;&emsp;首先创建一个基础模板统一页面布局：</p>
<figure class="highlight html"><figcaption><span>app/templates/layout.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;../static/bootstrap-icons.css&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;../static/bootstrap.min.css&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Flask Learn<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">&quot;bg-dark text-light&quot;</span>&gt;</span></span><br><span class="line">    &#123;% block header %&#125; Here is the header area! &#123;% endblock %&#125; &#123;% block aside %&#125;</span><br><span class="line">    Here is the aside area! &#123;% endblock %&#125; &#123;% block main %&#125; Here is the main</span><br><span class="line">    area! &#123;% endblock %&#125; &#123;% block footer %&#125; Here is the footer area! &#123;%</span><br><span class="line">    endblock%&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../static/bootstrap.bundle.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;然后编写头部导航、侧栏提示信息以及页脚：</p>
<figure class="highlight html"><figcaption><span>app/templates/base.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;layout.html&quot; %&#125; &#123;% block header %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;container-fluid header&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar navbar-expand-sm navbar-dark bg-dark&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span> <span class="attr">href</span>=<span class="string">&quot;javascript:;&quot;</span>&gt;</span>Flask Learn<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;navbar-toggler&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;button&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">data-bs-toggle</span>=<span class="string">&quot;collapse&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">data-bs-target</span>=<span class="string">&quot;#navbarNav&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">aria-controls</span>=<span class="string">&quot;navbarNav&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">aria-expanded</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">aria-label</span>=<span class="string">&quot;Toggle navigation&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;navbar-toggler-icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;collapse navbar-collapse justify-content-between&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">id</span>=<span class="string">&quot;navbarNav&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;navbar-nav&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link &#123;&#123;&#x27;active&#x27; if active==&#x27;index&#x27;&#125;&#125;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span></span></span><br><span class="line"><span class="tag">            &gt;</span>Home <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;bi bi-house-fill&quot;</span>&gt;</span>&lt;/i</span><br><span class="line">          &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">&quot;nav-link &#123;&#123;&#x27;active&#x27; if active==&#x27;customer&#x27;&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">href</span>=<span class="string">&quot;/customer&quot;</span></span></span><br><span class="line"><span class="tag">            &gt;</span>Customers <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;bi bi-person-fill&quot;</span>&gt;</span>&lt;/i</span><br><span class="line">          &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;text-end&quot;</span>&gt;</span></span><br><span class="line">        &#123;% if current_user and current_user.nickname %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/customer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span></span></span><br><span class="line"><span class="tag">          &gt;</span>&#123;&#123; current_user.nickname &#125;&#125; <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;bi bi-person-square&quot;</span>&gt;</span>&lt;/i</span><br><span class="line">        &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/user/logout&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-outline-primary&quot;</span></span></span><br><span class="line"><span class="tag">          &gt;</span>Logout <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;bi bi-box-arrow-left&quot;</span>&gt;</span>&lt;/i</span><br><span class="line">        &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">&quot;/user/login&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;btn &#123;&#123; &#x27;btn-primary&#x27; if active==&#x27;login&#x27; else &#x27;btn-outline-primary&#x27; &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">          &gt;</span>Login <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;bi bi-box-arrow-in-right&quot;</span>&gt;</span>&lt;/i</span><br><span class="line">        &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">&quot;/user/register&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;btn &#123;&#123; &#x27;btn-outline-primary&#x27; if active==&#x27;login&#x27; else &#x27;btn-primary&#x27; &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">          &gt;</span>Sign up <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;bio bi-people-fill&quot;</span>&gt;</span>&lt;/i</span><br><span class="line">        &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125; &#123;% block main %&#125; &#123;% endblock %&#125;&#123;% block aside %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;aside container&quot;</span>&gt;</span></span><br><span class="line">  &#123;% with messages=get_flashed_messages() %&#125; &#123;% for message in messages %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% if message %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-warning fs-6 text-break&quot;</span> <span class="attr">role</span>=<span class="string">&quot;alert&quot;</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125; &#123;% endwith %&#125; &#123;% if form and form.errors %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% for _,v in form.errors.items() %&#125; &#123;% for msg in v %&#125; &#123;% if msg %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-warning fs-6 text-break&quot;</span> <span class="attr">role</span>=<span class="string">&quot;alert&quot;</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125; &#123;% endfor %&#125; &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125; &#123;% block footer %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">&quot;footer w-100 py-3 text-center text-secondary fs-6&quot;</span>&gt;</span></span><br><span class="line">  <span class="symbol">&amp;copy;</span>Christopher-Teng</span><br><span class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;样式上面直接使用了 Bootstrap，相关静态文件放置与 app/static 下面：</p>
<img src="/2021/07/21/%E4%BD%BF%E7%94%A8Flask%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/static_dir.jpeg" class="" title="static files">
<p>&emsp;&emsp;其中，侧边栏中<code>&#123;% with messages=get_flashed_messages() %&#125;</code>使用了 Flask 提供的闪现(flash)在页面中嵌入视图函数中传入的自定义信息，<code>&#123;% if form and form.errors %&#125;</code>则是表单信息通过 wtforms 验证失败后的错误信息，通过在视图函数中使用<code>render_template</code>渲染模板时，传入 form 表单验证对象取得。</p>
<p>&emsp;&emsp;下面编写用户注册页面：</p>
<figure class="highlight html"><figcaption><span>app/templates/register.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125; &#123;% set active=&quot;register&quot; %&#125; &#123;% block main %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;main row my-3 text-secondary&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user/register&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-6 mx-auto px-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">id</span>=<span class="string">&quot;nicknameInput&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">placeholder</span>=<span class="string">&quot;your nickname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">&quot;nickname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">required</span></span></span><br><span class="line"><span class="tag">        <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;form.data.get(&#x27;nickname&#x27;)|default(&#x27;&#x27;,True)&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;nicknameInput&quot;</span>&gt;</span>Nickname<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">&quot;email&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">id</span>=<span class="string">&quot;emailInput&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">placeholder</span>=<span class="string">&quot;your email&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">&quot;email&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">required</span></span></span><br><span class="line"><span class="tag">        <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;form.data.get(&#x27;email&#x27;)|default(&#x27;&#x27;,True)&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;emailInput&quot;</span>&gt;</span>Email address<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">id</span>=<span class="string">&quot;phoneNumberInput&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">placeholder</span>=<span class="string">&quot;your phone number&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">&quot;phone_number&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">required</span></span></span><br><span class="line"><span class="tag">        <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;form.data.get(&#x27;phone_number&#x27;)|default(&#x27;&#x27;,True)&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;phoneNumberInput&quot;</span>&gt;</span>Phone number<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">id</span>=<span class="string">&quot;passwordInput&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">placeholder</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">required</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;passwordInput&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrf_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;csrf_token()&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;w-100 btn btn-primary btn-lg&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Sign up<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;上面注册表单中，<code>&lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;&#123;&#123;csrf_token()&#125;&#125;&quot; /&gt;</code>使用了表单隐藏字段，用于防御 CSRF(跨站请求伪造，Cross-site request forgery)，这是 flask-wtf 插件提供的功能，需要使用 flask-wtf 的 CsrfProtect 类的实例来初始化应用：</p>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> CsrfProtect</span><br><span class="line"></span><br><span class="line"><span class="comment"># def create_app():</span></span><br><span class="line">  <span class="comment"># app=Flask(__name__)</span></span><br><span class="line">  csrf=CsrfProtect()</span><br><span class="line">  csrf.init_app(app)</span><br><span class="line">  <span class="comment"># pass</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;到此，用户注册功能已经实现，下面实现用户登录功能。</p>
<h2 id="用户登录接口与页面"><a href="#用户登录接口与页面" class="headerlink" title="用户登录接口与页面"></a>用户登录接口与页面</h2><p>&emsp;&emsp;用户登录的代码和用户注册非常相似，主要区别是在表单数据上，登录页面可以使用注册过的邮箱或者手机号来进行用户验证，因此在视图函数中应该对表单数据做邮箱和手机号两方面验证，具体代码如下：</p>
<figure class="highlight python"><figcaption><span>app/manager/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="meta">  @auth.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST])</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="meta">  def login():</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="meta">    form=LoginForm()</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="meta">    if form.validate_on_submit():</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="meta">      email_or_phone_number=request.form.get(&quot;</span>email_or_phone_numbe<span class="string">r&quot;)</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="meta">      password=request.form.get(&quot;</span>password</span>)</span></span><br><span class="line">      user=_login(email_or_phone_number)</span><br><span class="line">      <span class="keyword">if</span> user <span class="keyword">and</span> user.check_password(password):</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;web.index&quot;</span>))</span><br><span class="line">      flash(<span class="string">u&quot;用户不存在或密码错误！&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>,form=form)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">_login</span>(<span class="params">email_or_phone_number</span>):</span></span><br><span class="line">    user=User.query.filter_by(email=email_or_phone_number).first() <span class="keyword">or</span> User.query.filter_by(</span><br><span class="line">      phone_number=email_or_phone_number).first()</span><br><span class="line">    <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;编写登录页表单验证：</p>
<figure class="highlight python"><figcaption><span>app/forms/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    email_or_phone_number = StringField(validators=[DataRequired()])</span><br><span class="line">    password = PasswordField(validators=[DataRequired(),</span><br><span class="line">                                         Length(<span class="built_in">min</span>=<span class="number">6</span>, <span class="built_in">max</span>=<span class="number">32</span>),</span><br><span class="line">                                         Regexp(<span class="string">r&quot;^\w&#123;6,32&#125;$&quot;</span>, flags=<span class="number">0</span>, message=<span class="string">u&quot;密码最少6位最多32位字符，并且不能使用特殊字符&quot;</span>)])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_email_or_phone_number</span>(<span class="params">self, field</span>):</span></span><br><span class="line">        res = re.search(</span><br><span class="line">            <span class="string">r&quot;^((\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*)|((13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\d&#123;8&#125;))$&quot;</span>,</span><br><span class="line">            field.data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> res:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&quot;please input email or phone number!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;以及登录页面：</p>
<figure class="highlight html"><figcaption><span>app/templates/login.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125; &#123;% set active=&quot;login&quot; %&#125; &#123;% block main %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;main row my-3 text-secondary&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span></span></span><br><span class="line"><span class="tag">    <span class="attr">action</span>=<span class="string">&quot;&#123;&#123;url_for(&#x27;auth.login&#x27;,next=request.args.get(&#x27;next&#x27;))&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;col-sm-6 mx-auto px-3&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">id</span>=<span class="string">&quot;emailOrPhoneNumberInput&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">placeholder</span>=<span class="string">&quot;email or phone number&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">&quot;email_or_phone_number&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">required</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;emailOrPhoneNumberInput&quot;</span>&gt;</span>Email / Phone number<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-floating mb-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">id</span>=<span class="string">&quot;passwordInput&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">placeholder</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">required</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;passwordInput&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-check mb-2 py-2 d-flex justify-content-center&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;form-check-input&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">id</span>=<span class="string">&quot;rememberMeCheck&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">&quot;remember_me&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">value</span>=<span class="string">&quot;remember_me&quot;</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;rememberMeCheck&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-check-label ms-2&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>Remember me&lt;/label</span><br><span class="line">      &gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrf_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;csrf_token()&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;w-100 btn btn-primary btn-lg&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="用户登录状态保持"><a href="#用户登录状态保持" class="headerlink" title="用户登录状态保持"></a>用户登录状态保持</h2><p>&emsp;&emsp;当用户登录以后，往往需要保持用户登录状态，一方面提高用户体验，不需要每次打开页面都要求重新登录，另一方面，在多个页面之间共享登录状态，实现访问控制和一些特殊的业务逻辑。</p>
<p>&emsp;&emsp;下面将使用 Flask 的第三方插件 flask-login 来实现登录状态保持，首先实例化一个 flask-login 插件的 LoginManager 类，然后初始化应用：</p>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> LoginManager</span><br><span class="line"></span><br><span class="line">login_manager=LoginManager()</span><br><span class="line"></span><br><span class="line"><span class="comment"># def create_app():</span></span><br><span class="line">  <span class="comment"># app=Flask(__name__)</span></span><br><span class="line">  login_manager.init_app(app)</span><br><span class="line">  <span class="comment"># pass</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;flask-login 提供了很多可配置项，下面首先配置 login_view——未登录时自动跳转的 endpoint 和提示信息：</p>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line">  <span class="comment"># login_manager.init_app(app)</span></span><br><span class="line">  login_manager.login_view=<span class="string">&quot;auth.login&quot;</span></span><br><span class="line">  login_manager.login_message=<span class="string">&quot;Please login first&quot;</span></span><br><span class="line">  <span class="comment"># pass</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;改写用户信息表的代码，加入 flask-login，具体用法可以网上查找文档自行了解：</p>
<figure class="highlight python"><figcaption><span>app/models/user.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base, UserMixin</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    nickname = Column(String(<span class="number">20</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    email = Column(String(<span class="number">50</span>), nullable=<span class="literal">False</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    phone_number = Column(<span class="string">&quot;phone_number&quot;</span>, String(<span class="number">11</span>), nullable=<span class="literal">False</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    _password = Column(<span class="string">&quot;password&quot;</span>, String(<span class="number">128</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">password</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._password</span><br><span class="line"></span><br><span class="line"><span class="meta">    @password.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">password</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        self._password = generate_password_hash(raw)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_password</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        <span class="keyword">return</span> check_password_hash(self.password, raw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_manager.user_loader</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_user</span>(<span class="params">uid</span>):</span></span><br><span class="line">    <span class="keyword">return</span> User.query.filter_by(<span class="built_in">id</span>=uid).first()</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;UserMixin 是 flask-login 提供的方便开发者进行扩展的基类，主要提供了一些使用 flask-login 所必须要实现的类方法。</p>
<p>&emsp;&emsp;flask-login 默认只在会话期间记录用户登录状态，但是可以通过指定 remember 的相关配置，在指定时间内保持登录状态。</p>
<p>&emsp;&emsp;首先在配置文件中对 flask-login 进行配置：</p>
<figure class="highlight python"><figcaption><span>app/__init__.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;!@#$%^&amp;*&quot;</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&quot;mysql+pymysql://root:123456@localhost:3306/flask&quot;</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">True</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATION = <span class="literal">True</span></span><br><span class="line">REMEMBER_COOKIE_DURATION = timedelta(days=<span class="number">7</span>)</span><br><span class="line">REMEMBER_COOKIE_HTTPONLY = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里配置为保存用户登录信息 7 天。接下来在用户登录视图函数中记录登录状态：</p>
<figure class="highlight python"><figcaption><span>app/manager/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="comment"># def login():</span></span><br><span class="line"><span class="comment">#   pass</span></span><br><span class="line"><span class="comment">#   if user and user.check_password(password):</span></span><br><span class="line">      login_user(user, remember=remember_me)</span><br><span class="line">            <span class="built_in">next</span> = request.args.get(<span class="string">&quot;next&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;next: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">next</span>))</span><br><span class="line">            <span class="built_in">next</span> = <span class="built_in">next</span> <span class="keyword">if</span> <span class="built_in">next</span> <span class="keyword">and</span> <span class="built_in">next</span>.startswith(<span class="string">&quot;/&quot;</span>) <span class="keyword">else</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="built_in">next</span>)</span><br><span class="line"><span class="comment">#   pass</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;其中，next 是当我们访问要求登录验证的页面时，flask-login 会将请求重定向到我们设置的<code>login_view</code>，而跳转前的 path 则会被已查询参数的方式记录下来，及 next 的值，因此当用户成功登录后，可以通过 next 参数将页面重定向到用户之前试图访问的页面，这里要注意对 next 进行必要的验证，防止通过访问登陆页面时指定恶意的 next 查询参数进行攻击。</p>
<p>&emsp;&emsp;最后，加上用户登出逻辑，并且添加一个用户页面进行访问控制：</p>
<figure class="highlight python"><figcaption><span>app/manager/auth.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&quot;/logout&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span>():</span></span><br><span class="line">    logout_user()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;web.index&quot;</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><figcaption><span>app/manager/web.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接上文</span></span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> login_required</span><br><span class="line"></span><br><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&quot;/customer&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">customer</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;customer.html&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>app/templates/customer.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125; &#123;% set active=&quot;customer&quot; %&#125; &#123;% block main %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;h1 text-center&quot;</span>&gt;</span></span><br><span class="line">    Welcome back,&#123;&#123;current_user.nickname | default(&quot;&quot;,true)&#125;&#125;!</span><br><span class="line">  <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;在本篇中，通过实现一个非常简单经典的用户注册、登录功能，熟悉了 flask 的基础开发流程，了解了 flask 中的消息闪现、jinja 模板以及 blueprint 蓝图，另外还涉及到了一些常用的 flask 第三方插件，主要有 flask-sqlalchemy 使用 ORM 数据模型进行数据库操作、flask-wtf 进行表单校验以及 flask-login 进行登录状态保持，并且通过自定义函数装饰器和上下文管理器对数据库操作进行了优化，实践了这两种 python 中的高级语法。文中项目完整代码参见<a target="_blank" rel="noopener" href="https://github.com/Christopher-Teng/flask_signup-login-logout">此处</a>。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"># Python</a>
              <a href="/tags/Flask/" rel="tag"># Flask</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/05/04/%E4%BD%BF%E7%94%A8Scrapy%E7%88%AC%E5%8F%96%E8%AF%97%E8%AF%8D%E6%95%B0%E6%8D%AE%EF%BC%88%E7%BB%88%EF%BC%89/" rel="prev" title="使用Scrapy爬取诗词数据（终）">
      <i class="fa fa-chevron-left"></i> 使用Scrapy爬取诗词数据（终）
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/06/JS%E4%B8%ADthis%E6%8C%87%E5%90%91%E7%B1%BB%E5%9E%8B%E6%80%BB%E7%BB%93/" rel="next" title="JS中this指向类型总结">
      JS中this指向类型总结 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">搭建项目结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.</span> <span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%92%8C%E8%93%9D%E5%9B%BE"><span class="nav-number">3.</span> <span class="nav-text">路由和蓝图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">4.</span> <span class="nav-text">连接数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E6%AD%A5%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.1.</span> <span class="nav-text">初步实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86"><span class="nav-number">4.2.</span> <span class="nav-text">对用户密码进行加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E6%9F%A5%E8%A1%A8%E6%9D%A1%E4%BB%B6"><span class="nav-number">4.3.</span> <span class="nav-text">设置默认查表条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E5%A4%B1%E8%B4%A5%E8%87%AA%E5%8A%A8%E5%9B%9E%E6%BB%9A"><span class="nav-number">4.4.</span> <span class="nav-text">操作失败自动回滚</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="nav-number">5.</span> <span class="nav-text">校验表单数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3%E4%B8%8E%E9%A1%B5%E9%9D%A2"><span class="nav-number">6.</span> <span class="nav-text">用户注册接口与页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%92%8C%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="nav-number">6.1.</span> <span class="nav-text">路由和视图函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E4%B8%8E%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2"><span class="nav-number">6.2.</span> <span class="nav-text">模板引擎与注册页面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3%E4%B8%8E%E9%A1%B5%E9%9D%A2"><span class="nav-number">7.</span> <span class="nav-text">用户登录接口与页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81%E4%BF%9D%E6%8C%81"><span class="nav-number">8.</span> <span class="nav-text">用户登录状态保持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">9.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">滕飞</p>
  <div class="site-description" itemprop="description">学海无涯，争渡争渡......</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Christopher-Teng</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  

    </div>
</body>
</html>
